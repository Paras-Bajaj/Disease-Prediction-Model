<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediScan Pro - Secure Authentication</title>
  <meta name="description" content="Secure medical authentication with military-grade encryption and HIPAA compliance.">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #059669 100%);
      min-height: 100vh;
    }
    
    .glass-effect {
      backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    .security-indicator {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 0.75rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      animation: pulse-security 2s infinite;
    }
    
    @keyframes pulse-security {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .auth-card {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(30, 64, 175, 0.1);
      box-shadow: 0 25px 50px -12px rgba(30, 64, 175, 0.25);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .auth-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 35px 60px -12px rgba(30, 64, 175, 0.35);
    }
    
    .input-secure {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(30, 64, 175, 0.1);
      transition: all 0.3s ease;
    }
    
    .input-secure:focus {
      background: rgba(255, 255, 255, 1);
      border-color: #1e40af;
      box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
      transform: translateY(-1px);
    }
    
    .btn-secure {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn-secure:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(30, 64, 175, 0.4);
    }
    
    .btn-secure::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn-secure:hover::before {
      left: 100%;
    }
    
    .encryption-visual {
      background: linear-gradient(45deg, #1e40af, #3b82f6, #10b981, #059669);
      background-size: 400% 400%;
      animation: encryption-flow 3s ease-in-out infinite;
    }
    
    @keyframes encryption-flow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .fade-in-up {
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.8s ease-out forwards;
    }
    
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .security-badge {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      padding: 6px 16px;
      border-radius: 25px;
      font-size: 0.8rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
  </style>
</head>
<body>
  <!-- Security Status Bar -->
  <div class="fixed top-0 left-0 right-0 z-50 bg-black/90 text-white py-2 px-4">
    <div class="container mx-auto flex justify-between items-center text-sm">
      <div class="flex items-center space-x-4">
        <div class="security-indicator">
          <i class="fas fa-shield-check"></i>
          <span>Secure Connection</span>
        </div>
        <div class="flex items-center space-x-2 text-green-400">
          <i class="fas fa-lock"></i>
          <span>256-bit Encryption Active</span>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2 text-blue-400">
          <i class="fas fa-certificate"></i>
          <span>HIPAA Compliant</span>
        </div>
        <div class="flex items-center space-x-2 text-yellow-400">
          <i class="fas fa-eye-slash"></i>
          <span>Zero Knowledge</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="pt-16 pb-8">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-md">
      <div class="text-center">
        <div class="flex items-center justify-center space-x-3 mb-4">
          <div class="w-12 h-12 encryption-visual rounded-xl flex items-center justify-center shadow-lg">
            <i class="fas fa-heartbeat text-white text-xl"></i>
          </div>
          <span class="text-3xl font-extrabold text-white">MediScan<span class="text-cyan-200">Pro</span></span>
        </div>
        
        <div class="flex justify-center space-x-3 mb-6">
          <span class="security-badge">
            <i class="fas fa-shield-alt"></i>
            Military Grade
          </span>
          <span class="security-indicator">
            <i class="fas fa-user-md"></i>
            Medical Certified
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Authentication -->
  <main class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-md pb-12">
    <!-- Authentication Form -->
    <div id="authForm" class="auth-card rounded-3xl p-8 fade-in-up">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Secure Access</h1>
        <p class="text-gray-600">Military-grade authentication for medical professionals</p>
        
        <!-- Security Indicators -->
        <div class="flex justify-center space-x-4 mt-4">
          <div class="flex items-center space-x-1 text-xs text-green-600">
            <i class="fas fa-check-circle"></i>
            <span>End-to-End Encrypted</span>
          </div>
          <div class="flex items-center space-x-1 text-xs text-blue-600">
            <i class="fas fa-shield-check"></i>
            <span>HIPAA Verified</span>
          </div>
        </div>
      </div>

      <!-- Tab Switcher -->
      <div class="flex bg-gray-100 rounded-xl p-1 mb-8">
        <button id="loginTab" class="flex-1 py-3 px-4 rounded-lg text-sm font-bold transition-all bg-white text-blue-600 shadow-sm">
          <i class="fas fa-sign-in-alt mr-2"></i>
          Secure Sign In
        </button>
        <button id="signupTab" class="flex-1 py-3 px-4 rounded-lg text-sm font-bold transition-all text-gray-600 hover:text-gray-900">
          <i class="fas fa-user-plus mr-2"></i>
          Create Account
        </button>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="space-y-6">
        <div>
          <label for="loginEmail" class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-envelope mr-2 text-blue-600"></i>
            Medical Email Address
          </label>
          <div class="relative">
            <input type="email" id="loginEmail" required
                   class="input-secure w-full px-4 py-4 pl-12 rounded-xl focus:outline-none"
                   placeholder="doctor@hospital.com">
            <i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
              <i class="fas fa-shield-check text-green-500 hidden" id="emailVerified"></i>
            </div>
          </div>
          <div class="text-red-500 text-sm mt-1" id="loginEmailError"></div>
        </div>

        <div>
          <label for="loginPassword" class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-lock mr-2 text-blue-600"></i>
            Secure Password
          </label>
          <div class="relative">
            <input type="password" id="loginPassword" required
                   class="input-secure w-full px-4 py-4 pl-12 pr-12 rounded-xl focus:outline-none"
                   placeholder="Enter your secure password">
            <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <button type="button" id="toggleLoginPassword" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="text-red-500 text-sm mt-1" id="loginPasswordError"></div>
        </div>

        <button type="submit" id="loginBtn" class="btn-secure w-full text-white py-4 px-6 rounded-xl font-bold text-lg relative overflow-hidden">
          <i class="fas fa-shield-check mr-2"></i>
          <span>Secure Sign In</span>
          <i class="fas fa-arrow-right ml-2"></i>
        </button>

        <!-- Security Features -->
        <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
          <div class="flex items-center space-x-2">
            <i class="fas fa-lock text-green-500"></i>
            <span>AES-256 Encrypted</span>
          </div>
          <div class="flex items-center space-x-2">
            <i class="fas fa-eye-slash text-blue-500"></i>
            <span>Zero Knowledge</span>
          </div>
          <div class="flex items-center space-x-2">
            <i class="fas fa-shield-alt text-red-500"></i>
            <span>HIPAA Compliant</span>
          </div>
          <div class="flex items-center space-x-2">
            <i class="fas fa-clock text-purple-500"></i>
            <span>Session Timeout</span>
          </div>
        </div>
      </form>

      <!-- Signup Form -->
      <form id="signupForm" class="space-y-6 hidden">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="signupFirstName" class="block text-sm font-bold text-gray-700 mb-2">First Name</label>
            <input type="text" id="signupFirstName" required
                   class="input-secure w-full px-4 py-3 rounded-xl focus:outline-none"
                   placeholder="John">
            <div class="text-red-500 text-sm mt-1" id="signupFirstNameError"></div>
          </div>
          <div>
            <label for="signupLastName" class="block text-sm font-bold text-gray-700 mb-2">Last Name</label>
            <input type="text" id="signupLastName" required
                   class="input-secure w-full px-4 py-3 rounded-xl focus:outline-none"
                   placeholder="Doe">
            <div class="text-red-500 text-sm mt-1" id="signupLastNameError"></div>
          </div>
        </div>

        <div>
          <label for="signupEmail" class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-envelope mr-2 text-blue-600"></i>
            Professional Email
          </label>
          <input type="email" id="signupEmail" required
                 class="input-secure w-full px-4 py-4 pl-12 rounded-xl focus:outline-none"
                 placeholder="doctor@hospital.com">
          <div class="text-red-500 text-sm mt-1" id="signupEmailError"></div>
        </div>

        <div>
          <label for="signupPassword" class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-lock mr-2 text-blue-600"></i>
            Secure Password
          </label>
          <input type="password" id="signupPassword" required
                 class="input-secure w-full px-4 py-4 pl-12 pr-12 rounded-xl focus:outline-none"
                 placeholder="Create secure password">
          <div class="text-red-500 text-sm mt-1" id="signupPasswordError"></div>
        </div>

        <div>
          <label for="confirmPassword" class="block text-sm font-bold text-gray-700 mb-2">Confirm Password</label>
          <input type="password" id="confirmPassword" required
                 class="input-secure w-full px-4 py-3 rounded-xl focus:outline-none"
                 placeholder="Confirm your password">
          <div class="text-red-500 text-sm mt-1" id="confirmPasswordError"></div>
        </div>

        <!-- Terms and Privacy -->
        <div class="space-y-3">
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="agreeTerms" required class="mt-1 rounded border-gray-300">
            <label for="agreeTerms" class="text-sm text-gray-600">
              I agree to the <a href="#" class="text-blue-600 hover:underline font-medium">Terms of Service</a> and 
              <a href="#" class="text-blue-600 hover:underline font-medium">Privacy Policy</a>
            </label>
          </div>
          
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="hipaaConsent" required class="mt-1 rounded border-gray-300">
            <label for="hipaaConsent" class="text-sm text-gray-600">
              I acknowledge HIPAA compliance requirements and data handling policies
            </label>
          </div>
        </div>
        <div class="text-red-500 text-sm" id="termsError"></div>

        <button type="submit" id="signupBtn" class="btn-secure w-full text-white py-4 px-6 rounded-xl font-bold text-lg">
          <i class="fas fa-user-plus mr-2"></i>
          <span>Create Secure Account</span>
          <i class="fas fa-shield-check ml-2"></i>
        </button>
      </form>
    </div>

    <!-- Two-Factor Authentication -->
    <div id="twoFactorForm" class="auth-card rounded-3xl p-8 fade-in-up hidden">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-mobile-alt text-white text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Two-Factor Authentication</h1>
        <p class="text-gray-600">Enter the 6-digit code sent to your email</p>
        <p class="text-blue-600 font-medium mt-2" id="twoFactorEmail"></p>
      </div>

      <form id="twoFactorVerificationForm" class="space-y-6">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-4 text-center">Authentication Code</label>
          <div class="flex justify-center space-x-3 mb-4">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" id="code1">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" id="code2">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" id="code3">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" id="code4">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" id="code5">
            <input type="text" maxlength="1" class="w-12 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" id="code6">
          </div>
          <div class="text-red-500 text-sm text-center" id="twoFactorError"></div>
        </div>

        <button type="submit" id="verifyTwoFactorBtn" class="btn-secure w-full text-white py-4 px-6 rounded-xl font-bold text-lg">
          <i class="fas fa-shield-check mr-2"></i>
          <span>Verify & Continue</span>
        </button>

        <div class="text-center space-y-3">
          <button type="button" id="resendCodeBtn" class="text-blue-600 hover:underline font-medium text-sm">
            Resend Code (<span id="resendTimer">60</span>s)
          </button>
          <br>
          <button type="button" id="backToAuthBtn" class="text-gray-600 hover:text-gray-800 font-medium text-sm">
            <i class="fas fa-arrow-left mr-1"></i>Back to Login
          </button>
        </div>
      </form>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="auth-card rounded-3xl p-8 fade-in-up hidden text-center">
      <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check text-white text-3xl"></i>
      </div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Authentication Successful!</h1>
      <p class="text-gray-600 mb-6">Welcome to MediScan Pro secure medical platform.</p>
      
      <div class="bg-green-50 rounded-xl p-4 border border-green-200 mb-6">
        <div class="flex items-center justify-center space-x-2 text-green-800">
          <i class="fas fa-shield-check"></i>
          <span class="font-medium">Secure session established</span>
        </div>
      </div>
      
      <div class="flex justify-center">
        <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
      </div>
      <p class="text-sm text-gray-500 mt-4">Redirecting to medical dashboard...</p>
    </div>
  </main>

  <!-- Security Footer -->
  <footer class="text-center py-6 text-white/80">
    <div class="container mx-auto px-4">
      <div class="flex justify-center space-x-6 mb-4 text-sm">
        <div class="flex items-center space-x-2">
          <i class="fas fa-certificate text-green-400"></i>
          <span>SOC 2 Certified</span>
        </div>
        <div class="flex items-center space-x-2">
          <i class="fas fa-shield-alt text-blue-400"></i>
          <span>ISO 27001</span>
        </div>
        <div class="flex items-center space-x-2">
          <i class="fas fa-lock text-red-400"></i>
          <span>GDPR Compliant</span>
        </div>
      </div>
      <p class="text-xs">© 2025 MediScan Pro. All rights reserved. Medical data protected by military-grade encryption.</p>
    </div>
  </footer>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  
  <!-- Fixed JavaScript -->
  <script>
    class SecureAuthentication {
      constructor() {
        this.currentUser = null;
        this.failedAttempts = 0;
        this.currentEmail = null; // Store current email for 2FA
        this.init();
        this.setupSecurityFeatures();
        this.initializeEmailJS();
      }

      initializeEmailJS() {
        // Initialize EmailJS with your public key
        if (window.emailjs) {
          emailjs.init("f9clUennlBGTcz80x");
        } else {
          console.error('EmailJS not loaded');
        }
      }

      init() {
        this.setupEventListeners();
        this.setupTwoFactorInputs();
        this.checkExistingSession();
      }

      setupEventListeners() {
        // Tab switching
        document.getElementById('loginTab')?.addEventListener('click', () => this.switchTab('login'));
        document.getElementById('signupTab')?.addEventListener('click', () => this.switchTab('signup'));

        // Form submissions
        document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
        document.getElementById('signupForm')?.addEventListener('submit', (e) => this.handleSignup(e));
        document.getElementById('twoFactorVerificationForm')?.addEventListener('submit', (e) => this.handleTwoFactor(e));

        // Password toggles
        document.getElementById('toggleLoginPassword')?.addEventListener('click', () => this.togglePassword('loginPassword'));

        // Back button
        document.getElementById('backToAuthBtn')?.addEventListener('click', () => this.showForm('auth'));

        // Resend code button
        document.getElementById('resendCodeBtn')?.addEventListener('click', () => this.resendCode());
      }

      switchTab(tab) {
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');

        if (tab === 'login') {
          loginTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
          loginTab.classList.remove('text-gray-600');
          signupTab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
          signupTab.classList.add('text-gray-600');
          
          loginForm.classList.remove('hidden');
          signupForm.classList.add('hidden');
        } else {
          signupTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
          signupTab.classList.remove('text-gray-600');
          loginTab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
          loginTab.classList.add('text-gray-600');
          
          signupForm.classList.remove('hidden');
          loginForm.classList.add('hidden');
        }

        this.clearAllErrors();
      }

      async handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        this.clearErrors(['loginEmail', 'loginPassword']);
        
        if (!this.validateLogin(email, password)) return;

        const loginBtn = document.getElementById('loginBtn');
        this.setButtonLoading(loginBtn, 'Authenticating...', 'fas fa-spinner fa-spin');

        try {
          await this.simulateSecureAuth();
          
          const users = JSON.parse(localStorage.getItem('mediscan_users_secure') || '[]');
          const user = users.find(u => u.email === email);
          
          if (!user) {
            this.showError('loginEmail', 'No account found with this email address');
            this.setButtonLoading(loginBtn, 'Secure Sign In', 'fas fa-shield-check', false);
            this.incrementFailedAttempts();
            return;
          }

          if (!await this.verifyPassword(password, user.passwordHash)) {
            this.showError('loginPassword', 'Invalid password');
            this.setButtonLoading(loginBtn, 'Secure Sign In', 'fas fa-shield-check', false);
            this.incrementFailedAttempts();
            return;
          }

          this.currentUser = {
            id: user.id,
            email: user.email,
            name: user.name,
            verified: user.verified
          };

          // Store the email for 2FA
          this.currentEmail = email;
          this.showTwoFactor(email);
          
        } catch (error) {
          console.error('Login error:', error);
          this.showNotification('Authentication failed. Please try again.', 'error');
          this.setButtonLoading(loginBtn, 'Secure Sign In', 'fas fa-shield-check', false);
          this.incrementFailedAttempts();
        }
      }

      async handleSignup(e) {
        e.preventDefault();
        const data = {
          signupFirstName: document.getElementById('signupFirstName').value.trim(),
          signupLastName: document.getElementById('signupLastName').value.trim(),
          signupEmail: document.getElementById('signupEmail').value.trim(),
          signupPassword: document.getElementById('signupPassword').value,
          confirmPassword: document.getElementById('confirmPassword').value
        };

        this.clearErrors(['signupFirstName', 'signupLastName', 'signupEmail', 'signupPassword', 'confirmPassword', 'terms']);
        
        if (!this.validateSignup(data)) return;

        const signupBtn = document.getElementById('signupBtn');
        this.setButtonLoading(signupBtn, 'Creating Account...', 'fas fa-spinner fa-spin');

        try {
          const users = JSON.parse(localStorage.getItem('mediscan_users_secure') || '[]');
          const existingUser = users.find(u => u.email === data.signupEmail);
          
          if (existingUser) {
            this.showError('signupEmail', 'An account with this email already exists');
            this.setButtonLoading(signupBtn, 'Create Secure Account', 'fas fa-user-plus', false);
            return;
          }

          const newUser = {
            id: this.generateSecureId(),
            name: `${data.signupFirstName} ${data.signupLastName}`,
            email: data.signupEmail,
            passwordHash: await this.hashPassword(data.signupPassword),
            createdAt: new Date().toISOString(),
            verified: true,
            twoFactorEnabled: true,
            securityLevel: 'high'
          };

          users.push(newUser);
          localStorage.setItem('mediscan_users_secure', JSON.stringify(users));

          this.currentUser = {
            id: newUser.id,
            email: newUser.email,
            name: newUser.name,
            verified: newUser.verified
          };

          // Store the email for 2FA
          this.currentEmail = data.signupEmail;
          this.showNotification('Account created successfully! Please complete two-factor authentication.', 'success');
          this.showTwoFactor(data.signupEmail);
          
        } catch (error) {
          console.error('Signup error:', error);
          this.showNotification('Account creation failed. Please try again.', 'error');
          this.setButtonLoading(signupBtn, 'Create Secure Account', 'fas fa-user-plus', false);
        }
      }

      async handleTwoFactor(e) {
        e.preventDefault();
        const code = Array.from({length: 6}, (_, i) => 
          document.getElementById(`code${i + 1}`).value
        ).join('');

        if (code.length !== 6) {
          this.showError('twoFactor', 'Please enter the complete 6-digit code');
          return;
        }

        const verifyBtn = document.getElementById('verifyTwoFactorBtn');
        this.setButtonLoading(verifyBtn, 'Verifying...', 'fas fa-spinner fa-spin');

        try {
          await this.simulateSecureAuth();
          
          const isValidCode = this.verifyTwoFactorCode(code);
          
          if (isValidCode) {
            this.createSecureSession();
            this.showForm('success');
            setTimeout(() => {
              this.showNotification('Redirecting to dashboard...', 'success');
              window.location.href = 'diagnosis.html';
            }, 2000);
          } else {
            this.showError('twoFactor', 'Invalid authentication code. Please check your email for the correct code.');
            this.setButtonLoading(verifyBtn, 'Verify & Continue', 'fas fa-shield-check', false);
            this.incrementFailedAttempts();
          }
        } catch (error) {
          console.error('2FA verification error:', error);
          this.showError('twoFactor', 'Verification failed. Please try again.');
          this.setButtonLoading(verifyBtn, 'Verify & Continue', 'fas fa-shield-check', false);
          this.incrementFailedAttempts();
        }
      }

      setupTwoFactorInputs() {
        // Auto-advance through 2FA inputs
        for (let i = 1; i <= 6; i++) {
          const input = document.getElementById(`code${i}`);
          input?.addEventListener('input', (e) => {
            if (e.target.value.length === 1 && i < 6) {
              document.getElementById(`code${i + 1}`).focus();
            }
          });
          
          input?.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value === '' && i > 1) {
              document.getElementById(`code${i - 1}`).focus();
            }
          });
        }
      }

      setupSecurityFeatures() {
        this.setupSessionTimeout();
        this.setupCSRFProtection();
      }

      setupSessionTimeout() {
        let timeout;
        const timeoutDuration = 15 * 60 * 1000; // 15 minutes

        const resetTimeout = () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            this.showNotification('Session expired for security. Please log in again.', 'warning');
            this.logout();
          }, timeoutDuration);
        };

        document.addEventListener('click', resetTimeout);
        document.addEventListener('keypress', resetTimeout);
        resetTimeout();
      }

      setupCSRFProtection() {
        const csrfToken = this.generateSecureToken();
        localStorage.setItem('csrf_token', csrfToken);
        
        document.querySelectorAll('form').forEach(form => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'csrf_token';
          input.value = csrfToken;
          form.appendChild(input);
        });
      }

      // Fixed email sending method
      async generateAndSendCode(email) {
        try {
          // Validate email first
          if (!email || !email.trim()) {
            console.error('Email is empty or undefined');
            this.showNotification('Email address is required for verification.', 'error');
            return false;
          }

          const trimmedEmail = email.trim();
          if (!this.isValidEmail(trimmedEmail)) {
            console.error('Invalid email format:', trimmedEmail);
            this.showNotification('Please provide a valid email address.', 'error');
            return false;
          }

          // Generate new verification code
          const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
          localStorage.setItem('verification_code', verificationCode);
          localStorage.setItem('code_timestamp', Date.now().toString());

          // Check if EmailJS is available
          if (!window.emailjs) {
            console.error('EmailJS not available');
            this.showNotification('Email service not available. Please try again.', 'error');
            return false;
          }

          // Await the emailjs.send promise
          const response = await emailjs.send("service_8zmat8u", "template_gw1bb16", {
            passcode: verificationCode,
            email: trimmedEmail
          });

          if (response.status === 200) {
            this.showNotification(`Verification code sent to ${trimmedEmail}`, 'success');
            return true;
          } else {
            throw new Error(`EmailJS returned status: ${response.status}`);
          }
        } catch (error) {
          console.error('Email sending failed:', error);
          this.showNotification('Failed to send verification code. Please try again.', 'error');
          return false;
        }
      }

      // Fixed verification method
      verifyTwoFactorCode(enteredCode) {
        const storedCode = localStorage.getItem('verification_code');
        const codeTimestamp = parseInt(localStorage.getItem('code_timestamp') || '0');
        const currentTime = Date.now();
        const isExpired = currentTime - codeTimestamp > 300000; // 5 minutes expiry

        if (isExpired && storedCode) {
          localStorage.removeItem('verification_code');
          localStorage.removeItem('code_timestamp');
          this.showError('twoFactor', 'Verification code expired. Please request a new one.');
          return false;
        }

        if (enteredCode === storedCode) {
          // Clear the code after successful verification
          localStorage.removeItem('verification_code');
          localStorage.removeItem('code_timestamp');
          return true;
        }

        return false;
      }

      // Security utility methods
      async simulateSecureAuth() {
        return new Promise(resolve => setTimeout(resolve, 1500));
      }

      async hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password + 'mediscan_salt');
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      }

      async verifyPassword(password, hash) {
        const computedHash = await this.hashPassword(password);
        return computedHash === hash;
      }

      generateSecureId() {
        return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }

      generateSecureToken() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
      }

      createSecureSession() {
        const sessionData = {
          user: this.currentUser,
          token: this.generateSecureToken(),
          timestamp: Date.now(),
          expiresAt: Date.now() + (24 * 60 * 60 * 1000), // 24 hours
          securityLevel: 'high',
          twoFactorVerified: true
        };
        localStorage.setItem('mediscan_session_secure', this.encrypt(JSON.stringify(sessionData)));
        localStorage.setItem('mediscan_user_secure', JSON.stringify(this.currentUser));
        // Ensure dashboard compatibility:
        localStorage.setItem('mediscan_user', JSON.stringify(this.currentUser));
        localStorage.setItem('mediscan_auth_token', sessionData.token);
      }

      encrypt(data) {
        return btoa(encodeURIComponent(data));
      }

      checkExistingSession() {
        const session = localStorage.getItem('mediscan_session_secure');
        if (session) {
          try {
            const sessionData = JSON.parse(decodeURIComponent(atob(session)));
            if (sessionData.expiresAt > Date.now()) {
              // Uncomment to redirect to dashboard
              window.location.href = 'diagnosis.html';
            }
          } catch (error) {
            localStorage.removeItem('mediscan_session_secure');
          }
        }
      }

      // Form management methods
      showForm(formType) {
        const forms = ['authForm', 'twoFactorForm', 'successMessage'];
        forms.forEach(form => {
          document.getElementById(form).classList.add('hidden');
        });
        
        if (formType === 'auth') {
          document.getElementById('authForm').classList.remove('hidden');
        } else if (formType === 'twoFactor') {
          document.getElementById('twoFactorForm').classList.remove('hidden');
        } else if (formType === 'success') {
          document.getElementById('successMessage').classList.remove('hidden');
        }
      }

      showTwoFactor(email) {
        document.getElementById('twoFactorEmail').textContent = email;
        this.showForm('twoFactor');
        this.startResendTimer();
        
        // Send verification code
        this.generateAndSendCode(email);
      }

      async resendCode() {
        const email = this.currentEmail || document.getElementById('twoFactorEmail').textContent;
        
        if (email && email.trim()) {
          const success = await this.generateAndSendCode(email);
          if (success) {
            this.startResendTimer();
          }
        } else {
          this.showNotification('No email address found for verification.', 'error');
        }
      }

      startResendTimer() {
        let seconds = 60;
        const timer = document.getElementById('resendTimer');
        const resendBtn = document.getElementById('resendCodeBtn');
        
        resendBtn.disabled = true;
        resendBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        const countdown = setInterval(() => {
          seconds--;
          if (timer) timer.textContent = seconds;
          
          if (seconds <= 0) {
            clearInterval(countdown);
            resendBtn.innerHTML = 'Resend Code';
            resendBtn.disabled = false;
            resendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }, 1000);
      }

      // Validation methods
      validateLogin(email, password) {
        let isValid = true;

        if (!email) {
          this.showError('loginEmail', 'Email is required');
          isValid = false;
        } else if (!this.isValidEmail(email)) {
          this.showError('loginEmail', 'Please enter a valid email address');
          isValid = false;
        }

        if (!password) {
          this.showError('loginPassword', 'Password is required');
          isValid = false;
        }

        return isValid;
      }

      validateSignup(data) {
        let isValid = true;

        if (!data.signupFirstName) {
          this.showError('signupFirstName', 'First name is required');
          isValid = false;
        }

        if (!data.signupLastName) {
          this.showError('signupLastName', 'Last name is required');
          isValid = false;
        }

        if (!data.signupEmail) {
          this.showError('signupEmail', 'Email is required');
          isValid = false;
        } else if (!this.isValidEmail(data.signupEmail)) {
          this.showError('signupEmail', 'Please enter a valid email address');
          isValid = false;
        }

        if (!data.signupPassword) {
          this.showError('signupPassword', 'Password is required');
          isValid = false;
        }

        if (!data.confirmPassword) {
          this.showError('confirmPassword', 'Please confirm your password');
          isValid = false;
        } else if (data.signupPassword !== data.confirmPassword) {
          this.showError('confirmPassword', 'Passwords do not match');
          isValid = false;
        }

        const agreeTermsChecked = document.getElementById('agreeTerms')?.checked;
        const hipaaConsentChecked = document.getElementById('hipaaConsent')?.checked;
        
        if (!agreeTermsChecked || !hipaaConsentChecked) {
          this.showError('terms', 'Please accept all required agreements');
          isValid = false;
        }

        return isValid;
      }

      isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      // UI utility methods
      togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input?.parentNode?.querySelector('button');
        const icon = button?.querySelector('i');
        
        if (!input || !icon) return;

        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      }

      setButtonLoading(button, text, icon, loading = true) {
        if (loading) {
          button.disabled = true;
          button.classList.add('opacity-75');
          button.innerHTML = `<i class="${icon} mr-2"></i><span>${text}</span>`;
        } else {
          button.disabled = false;
          button.classList.remove('opacity-75');
          button.innerHTML = `<i class="${icon} mr-2"></i><span>${text}</span>`;
        }
      }

      showError(fieldId, message) {
        const errorElement = document.getElementById(fieldId + 'Error');
        if (errorElement) {
          errorElement.textContent = message;
        }
      }

      clearErrors(fieldIds) {
        fieldIds.forEach(fieldId => {
          const errorElement = document.getElementById(fieldId + 'Error');
          if (errorElement) {
            errorElement.textContent = '';
          }
        });
      }

      clearAllErrors() {
        document.querySelectorAll('[id$="Error"]').forEach(element => {
          element.textContent = '';
        });
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full max-w-sm ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          type === 'warning' ? 'bg-yellow-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        
        notification.innerHTML = `
          <div class="flex items-start space-x-3">
            <i class="fas ${
              type === 'success' ? 'fa-check-circle' : 
              type === 'error' ? 'fa-exclamation-circle' : 
              type === 'warning' ? 'fa-exclamation-triangle' : 
              'fa-info-circle'
            } text-xl mt-0.5"></i>
            <div class="flex-1">
              <p class="font-medium">${message}</p>
            </div>
            <button class="text-white hover:text-gray-200 ml-2">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.remove('translate-x-full');
        }, 10);

        setTimeout(() => {
          this.removeNotification(notification);
        }, 5000);

        notification.querySelector('button').addEventListener('click', () => {
          this.removeNotification(notification);
        });
      }

      removeNotification(notification) {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }

      incrementFailedAttempts() {
        this.failedAttempts++;
        if (this.failedAttempts >= 5) {
          this.showNotification('Too many failed attempts. Please try again later.', 'error');
        }
      }

      logout() {
        localStorage.removeItem('mediscan_session_secure');
        localStorage.removeItem('mediscan_user_secure');
        localStorage.removeItem('verification_code');
        localStorage.removeItem('code_timestamp');
        this.showNotification('Logged out successfully', 'info');
      }
    }

    // Initialize secure authentication when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new SecureAuthentication();
    });
  </script>
</body>
</html>
